// AUTOGEN: pattern={{ pattern_name }} seed={{ seed }}
#include "ministd.h"
#include "trusted_lib_api.h"
#include <stdint.h>

ENTRY_POINT_ATTR void start()
{
    uint32_t vals[2] = { {{ random_vals | join(', ') }} };
    uint8_t file_data[{{ file_size }}] = { {{ file_data_init | join(', ') }} };
    const uint32_t len = sizeof(file_data);
    uint32_t len1 = sizeof(file_data);
    uint32_t len2 = sizeof(file_data);

{% if test_encrypted %}

    uint32_t iv[3] = {0};
    uint32_t tag[4] = {0};
    uint64_t h = TRUSTED_CALL(create_file_enc, file_data, len, iv, tag);

{% if invalid_first %}
    int32_t result_invalid_handle =
        TRUSTED_CALL(read_file_enc, {{ random_handle | ull }}, tag, file_data, &len1);

    int32_t result_correct_handle =
        TRUSTED_CALL(read_file_enc, h, tag, file_data, &len2);

    uint32_t extracted_invalid = vals[result_invalid_handle + 1];
    uint32_t extracted_correct = vals[result_correct_handle + 1];

    TRUSTED_CALL_VOID(
        mini_printf,
        "%x %d\n",
        extracted_invalid,
        extracted_correct
    );
{% else %}
    int32_t result_correct_handle =
        TRUSTED_CALL(read_file_enc, h, tag, file_data, &len1);

    int32_t result_invalid_handle =
        TRUSTED_CALL(read_file_enc, {{ random_handle | ull }}, tag, file_data, &len2);

    uint32_t extracted_correct = vals[result_correct_handle + 1];
    uint32_t extracted_invalid = vals[result_invalid_handle + 1];

    TRUSTED_CALL_VOID(
        mini_printf,
        "%d, %x\n",
        extracted_correct,
        extracted_invalid
    );
{% endif %}

{% else %}

    uint64_t h = TRUSTED_CALL(create_file_plain, file_data, len);

{% if invalid_first %}
    int32_t result_invalid_handle =
        TRUSTED_CALL(read_file_plain, {{ random_handle | ull }}, file_data, &len1);

    int32_t result_correct_handle =
        TRUSTED_CALL(read_file_plain, h, file_data, &len2);

    uint32_t extracted_invalid = vals[result_invalid_handle + 1];
    uint32_t extracted_correct = vals[result_correct_handle + 1];

    TRUSTED_CALL_VOID(
        mini_printf,
        "%x, %d\n",
        extracted_invalid,
        extracted_correct
    );
{% else %}
    int32_t result_correct_handle =
        TRUSTED_CALL(read_file_plain, h, file_data, &len1);

    int32_t result_invalid_handle =
        TRUSTED_CALL(read_file_plain, {{ random_handle | ull }}, file_data, &len2);

    uint32_t extracted_correct = vals[result_correct_handle + 1];
    uint32_t extracted_invalid = vals[result_invalid_handle + 1];

    TRUSTED_CALL_VOID(
        mini_printf,
        "%d %x\n",
        extracted_correct,
        extracted_invalid
    );
{% endif %}

{% endif %}

    ENTRY_POINT_END();
}