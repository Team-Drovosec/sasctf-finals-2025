import base64
import struct
import requests
import uuid
import ctypes

from z3_cracker import get_seed
from smgen import SMGen


t = requests.post(
    "http://localhost:25566/api/v1/register",
    json={"username": uuid.uuid4().hex[:10], "userClass": "miner"},
)
otp_secret = t.json()["otpSecret"]
print("OTP secret from server:", otp_secret)

padded_secret = otp_secret
while len(padded_secret) % 8 != 0:
    padded_secret += "="
raw = base64.b32decode(padded_secret.encode())
aint, bint = struct.unpack(">QQ", raw)
a = ctypes.c_uint64(aint).value
b = ctypes.c_uint64(bint).value


print(a, b)
s, g = get_seed(a, b)
print("Recovered seed:", s)
sm = SMGen(s, g)
a, sm1 = sm.next_word64()
b, sm2 = sm1.next_word64()

a1, sm3 = sm2.next_word64()
b1, sm4 = sm3.next_word64()

base32 = base64.b32encode(struct.pack(">QQ", a1, b1)).decode()
print("Derived next OTP secret:", base32)

# t = requests.post(
#     "http://localhost:25566/api/v1/register",
#     json={"username": uuid.uuid4().hex[:10], "userClass": "miner"},
# )
# otp_secret = t.json()["otpSecret"]
# print("OTP secret from server:", otp_secret)
